# Docker Compose for PHPWeave with BunkerWeb WAF (Local/Internal Setup)
# Security protection for internal networks without SSL/domain requirements
#
# BunkerWeb provides:
# - Web Application Firewall (ModSecurity + OWASP Core Rule Set)
# - DDoS protection and rate limiting
# - Bot detection and blocking
# - Security headers
# - Reverse proxy with caching
#
# USAGE:
# 1. No domain or SSL configuration needed!
# 2. Start services:
#    docker compose -f docker-compose.bunkerweb-local.yml up -d
#
# 3. Access:
#    - PHPWeave: http://localhost
#    - Admin UI: http://localhost:7000
#    - phpMyAdmin: http://localhost:8081
#
# Perfect for: Development, internal networks, testing, private LANs

services:
  # BunkerWeb WAF - Main reverse proxy with security features (HTTP only)
  bunkerweb:
    image: bunkerity/bunkerweb:1.6.5
    container_name: phpweave-bunkerweb-local
    ports:
      - "${HTTP_PORT:-80}:8080"  # HTTP only (no HTTPS)
    environment:
      # Server configuration
      - SERVER_NAME=localhost
      - MULTISITE=no
      - LOG_LEVEL=info

      # HTTP only (no SSL/TLS)
      - AUTO_LETS_ENCRYPT=no
      - LISTEN_HTTP=yes
      - DISABLE_DEFAULT_SERVER=no

      # Reverse proxy to PHPWeave
      - USE_REVERSE_PROXY=yes
      - REVERSE_PROXY_URL=/
      - REVERSE_PROXY_HOST=http://phpweave:80
      - REVERSE_PROXY_HEADERS=X-Forwarded-For $$remote_addr;X-Forwarded-Proto http;X-Forwarded-Host $$host;X-Real-IP $$remote_addr

      # ModSecurity WAF configuration
      - USE_MODSECURITY=yes
      - USE_MODSECURITY_CRS=yes
      - MODSECURITY_CRS_VERSION=4

      # Rate limiting (protection against DDoS) - More relaxed for internal use
      - USE_LIMIT_REQ=yes
      - LIMIT_REQ_URL=/
      - LIMIT_REQ_RATE=${RATE_LIMIT:-100r/s}  # 100 requests per second (relaxed)
      - USE_LIMIT_CONN=yes
      - LIMIT_CONN_MAX_HTTP1=50   # More connections allowed for internal use
      - LIMIT_CONN_MAX_HTTP2=200

      # Bot protection (optional for internal use)
      - USE_BAD_BEHAVIOR=${USE_BOT_PROTECTION:-no}
      - USE_DNSBL=no  # Disabled for local
      - USE_WHITELIST=yes
      - USE_GREYLIST=no
      - USE_BLACKLIST=yes

      # Security headers (HTTP-friendly)
      - COOKIE_FLAGS=* HttpOnly SameSite=Lax
      - COOKIE_AUTO_SECURE_FLAG=no  # No HTTPS
      - IFRAME_PROTECTION=same-origin
      - CONTENT_TYPE_NOSNIFF=yes
      - X_CONTENT_TYPE_OPTIONS=nosniff
      - REFERRER_POLICY=strict-origin-when-cross-origin

      # Caching (improves performance)
      - USE_CLIENT_CACHE=yes
      - CLIENT_CACHE_EXTENSIONS=jpg|jpeg|png|gif|ico|svg|css|js|woff|woff2|ttf|eot|webp
      - CLIENT_CACHE_CONTROL=public, max-age=2592000

      # Compression
      - USE_GZIP=yes
      - GZIP_TYPES=text/html text/css text/plain text/xml text/javascript application/javascript application/json application/xml+rss

      # API access (for scheduler and UI)
      - API_WHITELIST_IP=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16

      # Database connection (for settings persistence)
      - DATABASE_URI=mariadb+pymysql://bunkerweb:${BW_DB_PASSWORD:-changeme}@bw-db:3306/db

      # Redis for session/cache
      - USE_REDIS=yes
      - REDIS_HOST=redis
    labels:
      - "bunkerweb.INSTANCE=yes"
    volumes:
      - bw-data:/data
      - bw-cache:/var/cache/bunkerweb
      - bw-logs:/var/log/bunkerweb
    networks:
      - bw-universe
      - bw-services
    restart: unless-stopped
    depends_on:
      - bw-scheduler
      - phpweave

  # BunkerWeb Scheduler - Manages configuration and tasks
  bw-scheduler:
    image: bunkerity/bunkerweb-scheduler:1.6.5
    container_name: phpweave-bw-scheduler-local
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DATABASE_URI=mariadb+pymysql://bunkerweb:${BW_DB_PASSWORD:-changeme}@bw-db:3306/db
      - AUTOCONF_MODE=yes
      - API_WHITELIST_IP=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
      - LOG_LEVEL=info
    volumes:
      - bw-data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - bw-universe
      - bw-docker
    restart: unless-stopped
    depends_on:
      - bw-db
      - redis

  # BunkerWeb UI - Web-based administration interface
  bw-ui:
    image: bunkerity/bunkerweb-ui:1.6.5
    container_name: phpweave-bw-ui-local
    ports:
      - "${ADMIN_UI_PORT:-7000}:7000"
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DATABASE_URI=mariadb+pymysql://bunkerweb:${BW_DB_PASSWORD:-changeme}@bw-db:3306/db
      - ABSOLUTE_URI=http://localhost:7000
      - ADMIN_USERNAME=${BW_ADMIN_USER:-admin}
      - ADMIN_PASSWORD=${BW_ADMIN_PASSWORD:-changeme}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - bw-universe
      - bw-docker
    restart: unless-stopped
    depends_on:
      - bw-db

  # MariaDB - Database for BunkerWeb settings
  bw-db:
    image: mariadb:11
    container_name: phpweave-bw-db-local
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_DATABASE=db
      - MYSQL_USER=bunkerweb
      - MYSQL_PASSWORD=${BW_DB_PASSWORD:-changeme}
    volumes:
      - bw-db-data:/var/lib/mysql
    networks:
      - bw-universe
    restart: unless-stopped

  # Redis - Caching and session storage for BunkerWeb
  redis:
    image: redis:7-alpine
    container_name: phpweave-redis-local
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - bw-universe
    restart: unless-stopped

  # PHPWeave Application (protected by BunkerWeb)
  phpweave:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: phpweave-app-local
    expose:
      - "80"  # Internal only - not exposed to host (proxied through BunkerWeb)
    volumes:
      # Mount .env file
      - ./.env:/var/www/html/.env:ro
    environment:
      - DOCKER_ENV=${DOCKER_ENV:-development}
      - PHPWEAVE_ENV=${PHPWEAVE_ENV:-development}
      - BEHIND_PROXY=1
    restart: unless-stopped
    networks:
      - bw-services
      - phpweave-network
    depends_on:
      - db

  # MySQL Database for PHPWeave
  db:
    image: mysql:8.0
    container_name: phpweave-db-local
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-phpweave}
      MYSQL_USER: ${DB_USER:-phpweave_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-phpweave_pass}
    volumes:
      - db-data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - phpweave-network

  # Optional: phpMyAdmin for database management
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpweave-phpmyadmin-local
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: ${DB_USER:-phpweave_user}
      PMA_PASSWORD: ${DB_PASSWORD:-phpweave_pass}
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    depends_on:
      - db
    restart: unless-stopped
    networks:
      - phpweave-network

volumes:
  # BunkerWeb volumes
  bw-data:
    driver: local
  bw-cache:
    driver: local
  bw-logs:
    driver: local
  bw-db-data:
    driver: local
  redis-data:
    driver: local

  # PHPWeave volumes
  db-data:
    driver: local

networks:
  # BunkerWeb networks
  bw-universe:
    driver: bridge
    ipam:
      config:
        - subnet: 10.20.30.0/24
  bw-services:
    driver: bridge
  bw-docker:
    driver: bridge

  # PHPWeave network
  phpweave-network:
    driver: bridge
