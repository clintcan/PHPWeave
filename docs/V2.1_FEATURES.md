# PHPWeave v2.1 Features

This document describes the new features added in PHPWeave version 2.1.

## Table of Contents

- [PHPWeave Global Object](#phpweave-global-object)
- [Auto-Extracted View Variables](#auto-extracted-view-variables)
- [Backward Compatibility](#backward-compatibility)

## PHPWeave Global Object

### Overview

Version 2.1 introduces the `$PW` global object, providing a cleaner and more
intuitive API for accessing framework components.

### Model Access

**New Syntax (v2.1+):**

```php
global $PW;
$user = $PW->models->user_model->getUser($id);
$posts = $PW->models->blog_model->getAll();
```

**Benefits:**

- Cleaner, object-oriented syntax
- More intuitive than array access
- Foundation for future framework extensions
- Consistent API pattern

### Comparison with Legacy Syntax

```php
// New (v2.1+): PHPWeave global object (RECOMMENDED)
global $PW;
$user = $PW->models->user_model->getUser($id);

// Alternative: Helper function (still works)
$user = model('user_model')->getUser($id);

// Legacy: Array access (still supported, backward compatible)
global $models;
$user = $models['user_model']->getUser($id);
```

All three methods use the same underlying lazy loading mechanism, so there's
no performance difference.

### Controller Example

```php
<?php
class Blog extends Controller
{
    function index() {
        global $PW;
        $blogs = $PW->models->blog_model->getAll();

        $this->show("blog/index", [
            'title' => 'All Blog Posts',
            'blogs' => $blogs
        ]);
    }

    function show($id) {
        global $PW;
        $blog = $PW->models->blog_model->getById($id);

        $this->show("blog/show", [
            'title' => $blog['title'],
            'content' => $blog['content'],
            'author' => $blog['author']
        ]);
    }
}
```

## Auto-Extracted View Variables

### Overview

Version 2.1 enhances the `Controller::show()` method to automatically extract
array data into individual variables in views. This eliminates the need for
verbose `$data['key']` syntax.

### How It Works

**In Controller:**

```php
$this->show('blog/post', [
    'title' => 'My Blog Post',
    'content' => 'Hello World!',
    'author' => 'John Doe',
    'date' => '2025-01-26'
]);
```

**In View (views/blog/post.php):**
```php
<!-- New way: Direct variable access -->
<h1><?php echo $title; ?></h1>
<p><?php echo $content; ?></p>
<p>By <?php echo $author; ?> on <?php echo $date; ?></p>

<!-- Old way: Still works (backward compatible) -->
<h1><?php echo $data['title']; ?></h1>
<p><?php echo $data['content']; ?></p>
```

### Benefits

1. **Cleaner View Code**: Direct variable access is more readable
2. **Less Typing**: `$title` instead of `$data['title']`
3. **IDE-Friendly**: Better autocomplete support in modern IDEs
4. **Backward Compatible**: `$data` array still available

### Security

The extraction uses PHP's `extract()` function with the `EXTR_SKIP` flag:

```php
if (is_array($data)) {
    extract($data, EXTR_SKIP);
}
```

**EXTR_SKIP ensures:**

- Existing variables won't be overwritten
- Framework internal variables are protected (like `$this`, `$template`, etc.)
- No variable collision issues

### Complete Example

**Controller** (`controller/user.php`):

```php
<?php
class User extends Controller
{
    function profile($id) {
        global $PW;
        $user = $PW->models->user_model->getById($id);
        $posts = $PW->models->blog_model->getByUser($id);

        $this->show('user/profile', [
            'username' => $user['username'],
            'email' => $user['email'],
            'joined' => $user['created_at'],
            'posts' => $posts,
            'post_count' => count($posts)
        ]);
    }
}
```

**View** (`views/user/profile.php`):

```php
<!DOCTYPE html>
<html>
<head>
    <title><?php echo $username; ?>'s Profile</title>
</head>
<body>
    <h1><?php echo $username; ?></h1>
    <p>Email: <?php echo $email; ?></p>
    <p>Member since: <?php echo $joined; ?></p>

    <h2>Posts (<?php echo $post_count; ?>)</h2>
    <?php foreach ($posts as $post): ?>
        <article>
            <h3><?php echo $post['title']; ?></h3>
            <p><?php echo $post['excerpt']; ?></p>
        </article>
    <?php endforeach; ?>
</body>
</html>
```

### Non-Array Data

When passing non-array data (strings, objects, etc.), the data is still
accessible via `$data`:

```php
// Controller
$this->show('welcome', 'Hello World!');

// View
<p><?php echo $data; ?></p>
```

## Backward Compatibility

### 100% Backward Compatible

All v2.1 features are **fully backward compatible**. Existing code will
continue to work without any changes:

- `$models['model_name']` syntax still works
- `model('model_name')` helper function still works
- `$data` array in views still works
- All existing controllers, models, and views require zero changes

### Migration Strategy

**Option 1: Gradual Migration**

- Keep existing code as-is
- Use new syntax for new features
- Refactor old code over time

**Option 2: Mixed Approach**

- Use `$PW->models` in new controllers
- Keep `$models` in legacy controllers
- Both work seamlessly together

**Option 3: Full Migration**

- Update all controller code to use `$PW->models`
- Update all views to use extracted variables
- Consistent codebase with modern syntax

### IDE Support

For better IDE autocomplete and type hinting, you can add PHPDoc
comments:

```php
<?php
class Blog extends Controller
{
    function index() {
        /** @var PHPWeave $PW */
        global $PW;
        $blogs = $PW->models->blog_model->getAll();

        $this->show("blog/index", [
            'blogs' => $blogs
        ]);
    }
}
```

## Future Extensions

The `$PW` global object provides a foundation for future framework
enhancements:

**Potential future additions:**

```php
// Future possibilities (not yet implemented)
global $PW;

// Configuration access
$dbHost = $PW->config->get('database.host');

// Cache access
$PW->cache->set('key', 'value');
$value = $PW->cache->get('key');

// Session management
$PW->session->set('user_id', 123);

// Request/Response objects
$data = $PW->request->post('field');
$PW->response->json(['status' => 'ok']);

// Logger
$PW->log->info('User logged in');
```

## Implementation Details

### PHPWeave Class

Location: `coreapp/models.php`

```php
class PHPWeave {
    public $models;

    public function __construct() {
        $this->models = new LazyModelLoader();
    }
}

// Global instance
$PW = new PHPWeave();
$GLOBALS['PW'] = $PW;
```

### View Extraction

Location: `coreapp/controller.php` - `Controller::show()` method

```php
function show($template, $data=""){
    // ... template loading code ...

    // Extract array data into individual variables
    if (is_array($data)) {
        extract($data, EXTR_SKIP);
    }

    include_once "$dir/views/$template.php";

    // ...
}
```

## Summary

Version 2.1 brings two major developer experience improvements:

1. **$PW Global Object**: Cleaner API for framework components
2. **Auto-Extracted Views**: Simpler variable access in templates

Both features maintain 100% backward compatibility, allowing gradual adoption
without breaking existing code.

**Recommended Best Practices:**

- Use `$PW->models->model_name` in new controllers
- Pass arrays to views and use direct variable access
- Keep existing code working during gradual migration
- Document which pattern you're using in your team

---

**Version:** 2.1
**Date:** January 2025
**Backward Compatible:** Yes
**Migration Required:** No
