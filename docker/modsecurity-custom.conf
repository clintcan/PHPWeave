# PHPWeave ModSecurity Custom Configuration
# This file contains custom ModSecurity rules and settings for PHPWeave

# Set paranoia level (1-4, higher = more strict, more false positives)
# Level 1: Basic security (recommended for most applications)
# Level 2: Extended security
# Level 3: High security
# Level 4: Maximum security (use with caution)
SecAction \
  "id:900000,\
   phase:1,\
   nolog,\
   pass,\
   t:none,\
   setvar:tx.paranoia_level=1"

# Set anomaly score threshold
# Default: 5 for inbound, 4 for outbound
# Lower values = stricter blocking
SecAction \
 "id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"

# Set HTTP policy
# Allowed HTTP methods
SecAction \
 "id:900200,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_methods=GET HEAD POST OPTIONS PUT PATCH DELETE'"

# Allowed Content-Types
SecAction \
 "id:900220,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

# Allowed HTTP versions
SecAction \
 "id:900230,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0 HTTP/3'"

# File upload settings
SecAction \
 "id:900240,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:'tx.allowed_request_content_type_charset=utf-8|iso-8859-1|iso-8859-15|windows-1252'"

# Enable XML/JSON parsing
SecAction \
 "id:900250,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.enable_json_parsing=1,\
  setvar:tx.enable_xml_parsing=1"

# Block access to sensitive files (add to existing rules)
SecRule REQUEST_URI "@contains .env" \
    "id:1000001,\
     phase:1,\
     t:none,\
     block,\
     log,\
     msg:'Access to .env file blocked'"

SecRule REQUEST_URI "@rx (?:composer\.json|composer\.lock|package\.json|package-lock\.json)$" \
    "id:1000002,\
     phase:1,\
     t:none,\
     block,\
     log,\
     msg:'Access to configuration files blocked'"

# Allow PHPWeave-specific paths (whitelist rules)
# Adjust these based on your application needs

# Allow cache dashboard (if enabled)
SecRule REQUEST_URI "@streq /cache-dashboard" \
    "id:1000100,\
     phase:1,\
     t:none,\
     pass,\
     nolog,\
     ctl:ruleEngine=Off"

# Example: Whitelist specific routes if they trigger false positives
# SecRule REQUEST_URI "@streq /api/webhook" \
#     "id:1000101,\
#      phase:1,\
#      t:none,\
#      pass,\
#      nolog,\
#      ctl:ruleRemoveById=942100"

# Response headers (optional - already set in Dockerfile)
# Header always set X-Content-Type-Options "nosniff"
# Header always set X-Frame-Options "DENY"
# Header always set X-XSS-Protection "1; mode=block"

# Log configuration
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log

# Debug logging (disable in production)
# SecDebugLog /var/log/apache2/modsec_debug.log
# SecDebugLogLevel 0

# Collaborative Detection Mode (optional)
# Reports threats to OWASP without blocking
# SecAction "id:900001,phase:1,nolog,pass,t:none,setvar:tx.blocking_paranoia_level=1"
